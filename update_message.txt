リファクタリングとバグの修正を行いました。