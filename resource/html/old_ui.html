<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta http-equiv="Expires" content="86400">
        <link rel="stylesheet" type="text/css" href="../css/layout.css">
        <link rel="apple-touch-icon" sizes="180x180" href="../image/favicon/apple-touch-icon.png">
        <link rel="icon" type="image/png" sizes="32x32" href="../image/favicon/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="../image/favicon/favicon-16x16.png">
        <link rel="manifest" href="../image/favicon/site.webmanifest">
        <link rel="mask-icon" href="../image/favicon/safari-pinned-tab.svg" color="#ff6a00">
        <link rel="shortcut icon" href="../image/favicon/favicon.ico">
        <meta name="apple-mobile-web-app-title" content="ORIZIN Agent">
        <meta name="application-name" content="ORIZIN Agent">
        <meta name="msapplication-TileColor" content="#da532c">
        <meta name="msapplication-config" content="../image/favicon/browserconfig.xml">
        <meta name="theme-color" content="#2a1100">
        <title>ORIZIN Agent</title>
        <meta name="description" content="オープンソースのAIアシスタント「ORIZIN_Agent」です。">
    </head>
    <body>
        <header>
        </header>
        <main>
            <div class="main_control_panel">
                <div id="waiting" class="ripple_effect">
                  	<img src="../image/logo.svg" class="logo waiting_mark" id="start_recognition"><br>
                    マークをクリックするかスペースキーを押して話しかけてみてください。
                </div>
                <div id="listening" class="ripple_effect">
                    <img src="../image/listening.svg" class="logo listening_mark" id="end_recognition"><br>
                    マークをクリックするかスペースキーを押して話しかけてみてください。<br>
                    音声認識中...
                </div>
            </div>
            <div class="bottom_control_panel">
                <textarea id="requestForm">ここにテキストを入力してください。入力されたテキストに対する応答を読み上げます。</textarea>
                <button type="button" id="startButton" class="ripple_effect">実行</button>
            </div>
            <div id="result_area" class="bottom_control_panel ripple_effect">
                <!-- 新型コロナウイルス対策の外出自粛呼びかけメッセージ。　消すときはindex_chat.html内の記述も忘れずに。 -->
                新型コロナウイルスにかからない・うつさないためにマスクをし、他の人との距離を保ちましょう。<br>
            </div>
        </main>
        <script src="../javascript/jquery-3.5.1.min.js"></script>
        <script src="../javascript/basic.js"></script>
        <script src="../javascript/ripple.min.js"></script>
        <script src="/eel.js"></script>
        <script>
            function start_speak(content) {
                const script = new SpeechSynthesisUtterance(content);
                speechSynthesis.speak(script);
                script.onend = function() {
                    if(continuous_speech_recognition) {
                        jQuery("#start_recognition").click();
                    }
                }
            }

            async function response(content) {
                let script = await eel.make_response(content)();
                jQuery("#result_area").append(">>" + content + "<br>" + script[1] + "<br>");
                var result_area = document.getElementById("result_area");
                result_area.scrollTop = result_area.scrollHeight;
                start_speak(script[0]);
            }

            async function read_flag() {
                continuous_speech_recognition = await eel.read_flag("continuous_speech_recognition")();
            }
            continuous_speech_recognition = false;
            read_flag();

            const requestForm = document.querySelector('#requestForm');
      　    const startButton = document.querySelector('#startButton');
            startButton.addEventListener('click', function() {
                response(requestForm.value);
            });

            SpeechRecognition = webkitSpeechRecognition || SpeechRecognition;
            const recognition = new SpeechRecognition();
            recognition.onresult = (event) => {
                jQuery("#listening").fadeOut(300);
                jQuery("#waiting").fadeIn(300);
                response(event.results[0][0].transcript);
                is_listening = false;
            }

            is_listening = false;

            jQuery("#start_recognition").click(function() {
                if(is_listening) {
                    jQuery("#listening").fadeOut(300);
                    jQuery("#waiting").fadeIn(300);
                    recognition.abort();
                    is_listening = false;
                } else {
                    jQuery("#listening").fadeIn(300);
                    jQuery("#waiting").fadeOut(300);
                    is_listening = true;
                    recognition.start();
                }
            });

            jQuery("#end_recognition").click(function() {
                if(is_listening) {
                    jQuery("#listening").fadeOut(300);
                    jQuery("#waiting").fadeIn(300);
                    recognition.abort();
                    is_listening = false;
                }
            });

            jQuery(document).keydown(function(e) {
                switch (e.keyCode) {
                    case 32:
                    jQuery("#start_recognition").click();
                    break;
                }
            });
        </script>
        <style>
            #requestForm {
                width: 100%;
                height: 80%;
                border: 0;
                background: rgba(0, 0, 0, 0);
                color: var(--text);
                margin: 0;
                padding: 0;
                resize: none;
            }

            #startButton {
                 width: 30%;
                 height: 20%;
                 margin: 0;
                 padding: 0;
                 background: var(--theme_color);
                 border: 0;
                 color: white;
            }

            #start_recognition {
                transition: 0.3s;
            }

            #start_recognition:active {
                transform: scale(0.9);
            }

            #result_area {
                text-align: left;
                overflow: scroll;
            }

            #result_area::-webkit-scrollbar {
                display: none;
            }
        </style>
    </body>
</html>
